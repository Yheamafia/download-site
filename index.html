<script>
(() => {
  const btnSubscribe = document.querySelector('.sub');
  const btnLike = document.querySelector('.like');
  const btnConfirm = document.querySelector('.unlock');
  const downloadLink = document.getElementById('download');

  let step1 = false;
  let step2 = false;
  let step3 = false;

  let timer = null;
  let leftPageAt = null;

  function startExternalCheck(seconds, onSuccess) {
    leftPageAt = null;

    document.addEventListener('visibilitychange', function handle() {
      if (document.hidden) {
        leftPageAt = Date.now();
      } else if (leftPageAt) {
        const spent = (Date.now() - leftPageAt) / 1000;
        if (spent >= seconds) {
          document.removeEventListener('visibilitychange', handle);
          onSuccess();
        } else {
          alert('يجب البقاء في الصفحة الخارجية عدة ثواني لتنفيذ الشرط');
          leftPageAt = null;
        }
      }
    });
  }

  btnSubscribe.addEventListener('click', () => {
    if (step1) return;
    window.open(
      'https://www.youtube.com/@YHEAEBARON?sub_confirmation=1',
      '_blank'
    );

    startExternalCheck(8, () => {
      step1 = true;
      document.getElementById('s1').innerText = '✅ تم تنفيذ الشرط';
      btnLike.disabled = false;
      document.getElementById('s2').innerText = '❌ لم يتم';
    });
  });

  btnLike.addEventListener('click', () => {
    if (!step1 || step2) return;
    window.open(
      'https://www.youtube.com/watch?v=Uhsg5RmdK6c',
      '_blank'
    );

    startExternalCheck(8, () => {
      step2 = true;
      document.getElementById('s2').innerText = '✅ تم تنفيذ الشرط';
      btnConfirm.disabled = false;
      document.getElementById('s3').innerText = '❌ لم يتم';
    });
  });

  btnConfirm.addEventListener('click', () => {
    if (!step1 || !step2) {
      alert('نفذ جميع الشروط أولاً');
      return;
    }
    if (step3) return;
    step3 = true;
    document.getElementById('s3').innerText = '✅ تم التأكيد';
    downloadLink.classList.remove('hidden');
  });

  downloadLink.addEventListener('click', e => {
    if (!step1 || !step2 || !step3) {
      e.preventDefault();
      alert('لا يمكنك التحميل قبل تنفيذ جميع الشروط');
    }
  });
})();
</script>
